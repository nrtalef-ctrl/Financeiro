<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repasse Analítico - Gestor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { background-color: #0b0f1a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(249, 115, 22, 0.1); }
        .money-field { display: flex; align-items: center; background: #1e293b; border: 1px solid #334155; border-radius: 0.6rem; padding: 0 0.75rem; }
        .money-field input { background: transparent; border: none; outline: none; color: white; padding: 0.7rem 0; width: 100%; text-align: right; }
        .unit-pill:checked + label { background: #f97316; color: white; border-color: #f97316; }
    </style>
</head>
<body class="p-4 lg:p-8">

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
        <div>
            <h1 class="text-3xl font-black tracking-tighter text-white uppercase italic">Repasse <span class="text-orange-500">Gestor</span></h1>
            <p class="text-slate-400 text-sm font-semibold italic">Controle de Performance</p>
        </div>
        <div class="flex flex-wrap gap-3">
            <div class="flex flex-col">
                <label class="text-[9px] uppercase font-bold text-orange-500 ml-1">Mês</label>
                <select id="filterMes" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-xs font-bold outline-none text-white">
                    <option value="todos">Todos os Meses</option>
                    <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Março</option>
                    <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                    <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                    <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                </select>
            </div>
            <div class="flex flex-col">
                <label class="text-[9px] uppercase font-bold text-blue-500 ml-1">Ano</label>
                <select id="filterAno" class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-2 text-xs font-bold outline-none text-white">
                    <option value="2025" selected>2025</option><option value="2024">2024</option>
                </select>
            </div>
            <button id="btnOpenModal" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-6 rounded-xl shadow-xl text-xs self-end mb-1">
                + LANÇAR/EDITAR
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <div class="glass p-6 rounded-2xl border-l-4 border-emerald-500">
            <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Líquido Anual</span>
            <div id="cardAnual" class="text-3xl lg:text-4xl font-black text-white">R$ 0,00</div>
        </div>
        <div class="glass p-6 rounded-2xl border-l-4 border-orange-500">
            <span class="text-[10px] font-bold text-orange-400 uppercase block mb-1">Média Mensal</span>
            <div id="cardMediaLiq" class="text-3xl lg:text-4xl font-black text-white">R$ 0,00</div>
        </div>
        <div class="glass p-6 rounded-2xl border-l-4 border-blue-500">
            <span class="text-[10px] font-bold text-blue-400 uppercase block mb-1">Média Sem Pós</span>
            <div id="cardMediaSemPos" class="text-3xl lg:text-4xl font-black text-white">R$ 0,00</div>
        </div>
        <div class="glass p-6 rounded-2xl border-l-4 border-red-500">
            <span class="text-[10px] font-bold text-red-500 uppercase block mb-1">Total Glosas</span>
            <div id="cardNeg" class="text-3xl lg:text-4xl font-black text-white">R$ 0,00</div>
        </div>
    </div>

    <div class="glass p-4 rounded-2xl mb-8 flex flex-wrap gap-2 items-center">
        <input type="checkbox" id="u1" value="Recife" class="unit-pill hidden" checked><label for="u1" class="px-5 py-2 rounded-lg border border-slate-700 text-[10px] font-bold cursor-pointer transition-all">RECIFE</label>
        <input type="checkbox" id="u2" value="Gravatá" class="unit-pill hidden" checked><label for="u2" class="px-5 py-2 rounded-lg border border-slate-700 text-[10px] font-bold cursor-pointer transition-all">GRAVATÁ</label>
        <input type="checkbox" id="u3" value="Bezerros" class="unit-pill hidden" checked><label for="u3" class="px-5 py-2 rounded-lg border border-slate-700 text-[10px] font-bold cursor-pointer transition-all">BEZERROS</label>
        <input type="checkbox" id="u4" value="Amaraji" class="unit-pill hidden" checked><label for="u4" class="px-5 py-2 rounded-lg border border-slate-700 text-[10px] font-bold cursor-pointer transition-all">AMARAJI</label>
        <div class="h-6 w-[1px] bg-slate-700 mx-2"></div>
        <select id="filterSemestre" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-1 text-[10px] font-bold text-white outline-none">
            <option value="ano">Ano Completo</option>
            <option value="1sem">1º Semestre</option>
            <option value="2sem">2º Semestre</option>
        </select>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="glass p-6 rounded-[30px] h-[550px]"><canvas id="mainChart"></canvas></div>
        <div class="glass p-6 rounded-[30px] h-[550px]"><canvas id="barChart"></canvas></div>
    </div>

    <div id="dataModal" class="hidden fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-5xl rounded-[30px] border border-white/10 p-8 shadow-2xl overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold uppercase italic text-orange-500">Lançamento / Edição</h2>
                <div class="flex gap-4">
                    <button id="btnFetch" type="button" class="text-[10px] bg-blue-600 px-3 py-1 rounded-lg font-bold">CARREGAR DADOS EXISTENTES</button>
                    <button id="btnCloseModal" class="text-4xl text-slate-500 hover:text-white">&times;</button>
                </div>
            </div>
            <form id="dataForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 bg-slate-800/30 rounded-2xl">
                    <div><label class="block text-[10px] font-bold text-orange-500 uppercase mb-2">Unidade</label>
                        <select id="inUnidade" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-700 outline-none text-white">
                            <option>Recife</option><option>Gravatá</option><option>Bezerros</option><option>Amaraji</option>
                        </select>
                    </div>
                    <div><label class="block text-[10px] font-bold text-orange-500 uppercase mb-2">Mês</label>
                        <select id="inMes" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-700 outline-none text-white">
                            <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Março</option><option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option><option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option><option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                        </select>
                    </div>
                    <div><label class="block text-[10px] font-bold text-orange-500 uppercase mb-2">Ano</label>
                        <input type="number" id="inAno" value="2025" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-700 outline-none text-white">
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Mensalidade (v1)</label><div class="money-field"><span>R$</span><input type="text" id="v1" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">PTC (v2)</label><div class="money-field"><span>R$</span><input type="text" id="v2" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Prouni (v3)</label><div class="money-field"><span>R$</span><input type="text" id="v3" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Negociações (v4)</label><div class="money-field"><span>R$</span><input type="text" id="v4" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-orange-400">Pós (v5)</label><div class="money-field"><span>R$</span><input type="text" id="v5" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Crédito (v6)</label><div class="money-field"><span>R$</span><input type="text" id="v6" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Cooperada (v7)</label><div class="money-field"><span>R$</span><input type="text" id="v7" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Nota Serv. (v8)</label><div class="money-field"><span>R$</span><input type="text" id="v8" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-blue-400">Dependências (v11)</label><div class="money-field border-blue-900/40"><span>R$</span><input type="text" id="v11" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-red-500">Débito (v9)</label><div class="money-field border-red-900/40"><span>R$</span><input type="text" id="v9" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-red-500">Estornos (v10)</label><div class="money-field border-red-900/40"><span>R$</span><input type="text" id="v10" class="money-input"></div></div>
                </div>
                <button type="submit" class="w-full bg-orange-600 py-4 rounded-xl font-black uppercase text-white hover:bg-orange-500 shadow-xl">Salvar Alterações</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBM35B6f1wetJCLtbVPo4wk0tQutE0vvug",
            authDomain: "repasse-unopar.firebaseapp.com",
            projectId: "repasse-unopar",
            databaseURL: "https://repasse-unopar-default-rtdb.firebaseio.com",
            storageBucket: "repasse-unopar.firebasestorage.app",
            appId: "1:71926249218:web:cebe16f726d6ddafbb341b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        Chart.register(ChartDataLabels);

        let dataCloud = [];
        const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const parseV = v => parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0;
        const toBr = v => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Máscara Dinheiro
        document.querySelectorAll('.money-input').forEach(i => i.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, "");
            v = (v / 100).toFixed(2).replace(".", ",");
            v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            e.target.value = v;
        }));

        const commonOpt = {
            responsive: true, maintainAspectRatio: false,
            layout: { padding: { top: 120, bottom: 20, left: 15, right: 15 } },
            plugins: {
                legend: { labels: { color: '#94a3b8', font: { weight: 'bold' } } },
                datalabels: { color: '#fff', font: { size: 12, weight: '900' }, anchor: 'end', align: 'top', offset: 12, formatter: v => v != 0 ? fmt.format(v) : '' }
            },
            scales: { y: { display: false }, x: { ticks: { color: '#64748b', font: { weight: 'bold' } }, grid: { display: false } } }
        };

        const mainChart = new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: { labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], datasets: [{ label: 'Repasse Líquido Real', data: [], borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.4 }] },
            options: commonOpt
        });

        const barChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: ['Mens.','PTC/Pro.','Negoc.','Pós','Dep.','Glosas'], datasets: [{ label: 'Composição Financeira', data: [], backgroundColor: ['#f97316','#3b82f6','#f59e0b','#8b5cf6','#06b6d4','#ef4444'], borderRadius: 8, barPercentage: 0.95 }] },
            options: commonOpt
        });

        onValue(ref(db, 'lancamentos'), (snapshot) => {
            dataCloud = snapshot.val() ? Object.values(snapshot.val()) : [];
            updateDashboard();
        });

        function updateDashboard() {
            const selUnits = Array.from(document.querySelectorAll('.unit-pill:checked')).map(i => i.value);
            const selAno = parseInt(document.getElementById('filterAno').value);
            const selMes = document.getElementById('filterMes').value;
            const selSemestre = document.getElementById('filterSemestre').value;

            let mensalLiq = Array(12).fill(0), cats = Array(6).fill(0);
            let totalLiq = 0, totalNeg = 0, totalSemPos = 0, countMeses = 0;

            dataCloud.forEach(d => {
                if (d.a === selAno && selUnits.includes(d.u)) {
                    const entradas = (d.v.v1+d.v.v2+d.v.v3+d.v.v4+d.v.v5+d.v.v6+d.v.v7+d.v.v8);
                    const glosas = (d.v.v9 + d.v.v10);
                    const liq = entradas - glosas;

                    mensalLiq[d.m] += liq;
                    
                    const inSemestre = (selSemestre === "ano") || (selSemestre === "1sem" && d.m <= 5) || (selSemestre === "2sem" && d.m >= 6);
                    
                    if (inSemestre) {
                        totalLiq += liq;
                        totalSemPos += (liq - d.v.v5);
                        totalNeg += glosas;
                        countMeses++;
                        
                        if (selMes === "todos" || parseInt(selMes) === d.m) {
                            cats[0]+=d.v.v1; cats[1]+=(d.v.v2+d.v.v3); cats[2]+=d.v.v4;
                            cats[3]+=d.v.v5; cats[4]+=d.v.v11; cats[5]+=glosas;
                        }
                    }
                }
            });

            document.getElementById('cardAnual').innerText = fmt.format(totalLiq);
            document.getElementById('cardMediaLiq').innerText = fmt.format(totalLiq / (countMeses || 1));
            document.getElementById('cardMediaSemPos').innerText = fmt.format(totalSemPos / (countMeses || 1));
            document.getElementById('cardNeg').innerText = fmt.format(totalNeg);

            mainChart.data.datasets[0].data = mensalLiq;
            barChart.data.datasets[0].data = cats;
            mainChart.update(); barChart.update();
        }

        // FUNÇÃO DE EDIÇÃO: Carrega dados do Firebase para o Form
        document.getElementById('btnFetch').onclick = async () => {
            const u = document.getElementById('inUnidade').value;
            const m = document.getElementById('inMes').value;
            const a = document.getElementById('inAno').value;
            const snapshot = await get(ref(db, `lancamentos/${u}_${a}_${m}`));
            
            if (snapshot.exists()) {
                const d = snapshot.val().v;
                ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11'].forEach(id => {
                    document.getElementById(id).value = toBr(d[id] || 0);
                });
                alert("Dados carregados para edição!");
            } else {
                alert("Nenhum dado encontrado para este período. Iniciando novo lançamento.");
            }
        };

        document.getElementById('dataForm').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('inUnidade').value, m = parseInt(document.getElementById('inMes').value), a = parseInt(document.getElementById('inAno').value);
            const rec = { u, m, a, v: {} };
            ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11'].forEach(id => rec.v[id] = parseV(document.getElementById(id).value));

            await set(ref(db, `lancamentos/${u}_${a}_${m}`), rec);
            document.getElementById('dataModal').classList.add('hidden');
            document.getElementById('dataForm').reset();
            alert("Salvo com sucesso!");
        };

        document.getElementById('btnOpenModal').onclick = () => document.getElementById('dataModal').classList.remove('hidden');
        document.getElementById('btnCloseModal').onclick = () => document.getElementById('dataModal').classList.add('hidden');
        document.getElementById('filterMes').onchange = updateDashboard;
        document.getElementById('filterAno').onchange = updateDashboard;
        document.getElementById('filterSemestre').onchange = updateDashboard;
        document.querySelectorAll('.unit-pill').forEach(cb => cb.onchange = updateDashboard);
    </script>
</body>
</html>
