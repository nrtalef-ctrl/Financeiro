<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repasse Gestor - Controle de Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { background-color: #0b0f1a; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; } /* Trava o scroll */
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(249, 115, 22, 0.1); }
        .unit-pill:checked + label { background: #f97316; color: white; border-color: #f97316; }
        
        .switch-pos { position: relative; display: inline-block; width: 30px; height: 16px; }
        .switch-pos input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #f97316; }
        input:checked + .slider:before { transform: translateX(14px); }
        
        /* Ajuste para telas menores/cheias */
        .money-field { display: flex; align-items: center; background: #1e293b; border: 1px solid #334155; border-radius: 0.4rem; padding: 0 0.5rem; }
        .money-field input { background: transparent; border: none; outline: none; color: white; padding: 0.4rem 0; width: 100%; text-align: right; font-size: 0.8rem; }
    </style>
</head>
<body class="p-2 lg:p-4 h-screen flex flex-col">

    <header class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-white uppercase italic">Repasse <span class="text-orange-500">Gestor</span></h1>
            <p class="text-slate-400 text-[10px] font-semibold italic">Controle de Performance</p>
        </div>
        <div class="flex gap-2">
            <select id="filterMes" class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-white outline-none">
                <option value="todos">Todos os Meses</option>
                <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
            </select>
            <select id="filterAno" class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-white outline-none">
                <option value="2025" selected>2025</option><option value="2024">2024</option>
            </select>
            <button id="btnOpenModal" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-1 px-4 rounded-lg shadow-xl text-[10px]">
                + LANÇAR
            </button>
        </div>
    </header>

    <div class="grid grid-cols-4 gap-3 mb-4">
        <div class="glass p-3 rounded-xl border-l-4 border-emerald-500">
            <span class="text-[8px] font-bold text-slate-400 uppercase block">Líquido Anual</span>
            <div id="cardAnual" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
        <div class="glass p-3 rounded-xl border-l-4 border-orange-500">
            <span class="text-[8px] font-bold text-orange-400 uppercase block">Média Mensal</span>
            <div id="cardMediaLiq" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
        <div class="glass p-3 rounded-xl border-l-4 border-blue-500">
            <span class="text-[8px] font-bold text-blue-400 uppercase block">Média Sem Pós</span>
            <div id="cardMediaSemPos" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
        <div class="glass p-3 rounded-xl border-l-4 border-red-500">
            <span class="text-[8px] font-bold text-red-500 uppercase block">Total Glosas</span>
            <div id="cardNeg" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
    </div>

    <div class="glass p-2 rounded-xl mb-4 flex gap-2 items-center justify-between">
        <div class="flex gap-2">
            <input type="checkbox" id="u1" value="Recife" class="unit-pill hidden" checked><label for="u1" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer">RECIFE</label>
            <input type="checkbox" id="u2" value="Gravatá" class="unit-pill hidden" checked><label for="u2" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer">GRAVATÁ</label>
            <input type="checkbox" id="u3" value="Bezerros" class="unit-pill hidden" checked><label for="u3" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer">BEZERROS</label>
            <input type="checkbox" id="u4" value="Amaraji" class="unit-pill hidden" checked><label for="u4" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer">AMARAJI</label>
        </div>
        <select id="filterSemestre" class="bg-slate-800 border border-slate-700 rounded-md px-2 py-1 text-[9px] font-bold text-white outline-none">
            <option value="ano">Ano Completo</option>
            <option value="1sem">1º Semestre</option>
            <option value="2sem">2º Semestre</option>
        </select>
    </div>

    <div class="grid grid-cols-2 gap-4 flex-grow overflow-hidden pb-2">
        <div class="glass p-4 rounded-[20px] relative h-full">
            <div id="precisionDisplay" class="absolute top-4 right-4 z-10 bg-slate-800/90 border border-orange-500/30 p-2 rounded-lg backdrop-blur-md">
                <div class="flex justify-between items-center gap-4 mb-1">
                    <span class="text-[8px] uppercase font-bold text-slate-400" id="precisionTitle">Mês</span>
                    <label class="switch-pos"><input type="checkbox" id="checkExatoPos" checked><span class="slider"></span></label>
                </div>
                <div id="precisionValue" class="text-sm font-black text-orange-500 leading-none">R$ 0,00</div>
            </div>
            <canvas id="mainChart"></canvas>
        </div>
        <div class="glass p-4 rounded-[20px] h-full">
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <div id="dataModal" class="hidden fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-2">
        <div class="bg-slate-900 w-full max-w-4xl rounded-2xl border border-white/10 p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold uppercase text-orange-500 italic">Lançamento</h2>
                <button id="btnCloseModal" class="text-2xl text-slate-500 hover:text-white">&times;</button>
            </div>
            <form id="dataForm" class="space-y-4">
                <div class="grid grid-cols-3 gap-4 bg-slate-800/30 p-4 rounded-xl">
                    <select id="inUnidade" class="bg-slate-800 p-2 rounded-lg border border-slate-700 text-xs text-white"><option>Recife</option><option>Gravatá</option><option>Bezerros</option><option>Amaraji</option></select>
                    <select id="inMes" class="bg-slate-800 p-2 rounded-lg border border-slate-700 text-xs text-white"><option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Março</option><option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option><option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option><option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option></select>
                    <input type="number" id="inAno" value="2025" class="bg-slate-800 p-2 rounded-lg border border-slate-700 text-xs text-white">
                </div>
                <div class="grid grid-cols-4 gap-2">
                    <div class="money-field"><span>R$</span><input type="text" id="v1" placeholder="V1" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v2" placeholder="V2" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v3" placeholder="V3" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v4" placeholder="V4" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v5" placeholder="Pós" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v6" placeholder="V6" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v7" placeholder="V7" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v8" placeholder="V8" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v9" placeholder="Déb" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v10" placeholder="Est" class="money-input"></div>
                    <div class="money-field"><span>R$</span><input type="text" id="v11" placeholder="Dep" class="money-input"></div>
                </div>
                <button type="submit" class="w-full bg-orange-600 py-3 rounded-lg font-bold uppercase text-white hover:bg-orange-500">Salvar</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBM35B6f1wetJCLtbVPo4wk0tQutE0vvug",
            authDomain: "repasse-unopar.firebaseapp.com",
            projectId: "repasse-unopar",
            databaseURL: "https://repasse-unopar-default-rtdb.firebaseio.com",
            storageBucket: "repasse-unopar.firebasestorage.app",
            appId: "1:71926249218:web:cebe16f726d6ddafbb341b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        Chart.register(ChartDataLabels);

        let dataCloud = [];
        const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const shortFmt = v => v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v.toFixed(0);
        const parseV = v => parseFloat(v.replace(/\./g, '').replace(',', '.')) || 0;
        const toBr = v => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        document.querySelectorAll('.money-input').forEach(i => i.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, "");
            v = (v / 100).toFixed(2).replace(".", ",");
            v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            e.target.value = v;
        }));

        const commonOpt = {
            responsive: true, maintainAspectRatio: false,
            layout: { padding: { top: 30, bottom: 5, left: 5, right: 5 } },
            plugins: {
                legend: { display: false },
                datalabels: { 
                    color: '#94a3b8', font: { size: 9, weight: 'bold' }, anchor: 'end', align: 'top', offset: 2, 
                    formatter: v => v !== 0 ? shortFmt(v) : '' 
                }
            },
            scales: { 
                y: { display: true, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { display: false } }, 
                x: { ticks: { color: '#64748b', font: { size: 9 } }, grid: { display: false } } 
            }
        };

        const mainChart = new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: { labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], datasets: [{ data: [], borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.05)', fill: true, tension: 0.4, pointRadius: 2 }] },
            options: commonOpt
        });

        const barChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { labels: ['Mens.','PTC/Pro.','Negoc.','Pós','Dep.','Glosas'], datasets: [{ data: [], backgroundColor: ['#f97316','#3b82f6','#f59e0b','#8b5cf6','#06b6d4','#ef4444'], borderRadius: 4 }] },
            options: commonOpt
        });

        onValue(ref(db, 'lancamentos'), (snapshot) => {
            dataCloud = snapshot.val() ? Object.values(snapshot.val()) : [];
            updateDashboard();
        });

        function updateDashboard() {
            const selUnits = Array.from(document.querySelectorAll('.unit-pill:checked')).map(i => i.value);
            const selAno = parseInt(document.getElementById('filterAno').value);
            const selMes = document.getElementById('filterMes').value;
            const comPosExato = document.getElementById('checkExatoPos').checked;

            let mensalLiq = Array(12).fill(0), mensalSemPos = Array(12).fill(0), cats = Array(6).fill(0);
            let totalLiq = 0, totalNeg = 0, totalSemPos = 0, countMeses = 0;

            dataCloud.forEach(d => {
                if (d.a === selAno && selUnits.includes(d.u)) {
                    const liq = (d.v.v1+d.v.v2+d.v.v3+d.v.v4+(d.v.v5||0)+d.v.v6+d.v.v7+d.v.v8) - (d.v.v9+d.v.v10);
                    mensalLiq[d.m] += liq;
                    mensalSemPos[d.m] += (liq - (d.v.v5 || 0));
                    totalLiq += liq;
                    totalSemPos += (liq - (d.v.v5 || 0));
                    totalNeg += (d.v.v9+d.v.v10);
                    countMeses++;
                    if (selMes !== "todos" && parseInt(selMes) === d.m) {
                        cats[0]+=d.v.v1; cats[1]+=(d.v.v2+d.v.v3); cats[2]+=d.v.v4;
                        cats[3]+=(d.v.v5||0); cats[4]+=(d.v.v11||0); cats[5]+=(d.v.v9+d.v.v10);
                    }
                }
            });

            const idx = selMes === "todos" ? (new Date().getMonth()) : parseInt(selMes);
            document.getElementById('precisionValue').innerText = fmt.format(comPosExato ? mensalLiq[idx] : mensalSemPos[idx]);
            document.getElementById('precisionTitle').innerText = selMes === "todos" ? "Atual" : mainChart.data.labels[idx];

            document.getElementById('cardAnual').innerText = fmt.format(totalLiq);
            document.getElementById('cardMediaLiq').innerText = fmt.format(totalLiq / (countMeses || 1));
            document.getElementById('cardMediaSemPos').innerText = fmt.format(totalSemPos / (countMeses || 1));
            document.getElementById('cardNeg').innerText = fmt.format(totalNeg);

            mainChart.data.datasets[0].data = mensalLiq;
            barChart.data.datasets[0].data = cats;
            mainChart.update(); barChart.update();
        }

        document.getElementById('btnOpenModal').onclick = () => document.getElementById('dataModal').classList.remove('hidden');
        document.getElementById('btnCloseModal').onclick = () => document.getElementById('dataModal').classList.add('hidden');
        document.getElementById('filterMes').onchange = updateDashboard;
        document.getElementById('filterAno').onchange = updateDashboard;
        document.getElementById('checkExatoPos').onchange = updateDashboard;
        document.querySelectorAll('.unit-pill').forEach(cb => cb.onchange = updateDashboard);
    </script>
</body>
</html>
