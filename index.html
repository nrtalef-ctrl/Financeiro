<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repasse Gestor - Performance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { background-color: #0b0f1a; color: #f8fafc; font-family: 'Inter', sans-serif; overflow: hidden; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(249, 115, 22, 0.1); }
        .unit-pill:checked + label { background: #f97316; color: white; border-color: #f97316; }
        .switch-pos { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch-pos input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #334155; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 12px; width: 12px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #f97316; }
        input:checked + .slider:before { transform: translateX(16px); }
        .money-field { display: flex; align-items: center; background: #1e293b; border: 1px solid #334155; border-radius: 0.6rem; padding: 0 0.75rem; }
        .money-field input { background: transparent; border: none; outline: none; color: white; padding: 0.7rem 0; width: 100%; text-align: right; }
    </style>
</head>
<body class="p-2 lg:p-4 h-screen flex flex-col">

    <header class="flex justify-between items-center mb-4">
        <div>
            <h1 class="text-2xl font-black tracking-tighter text-white uppercase italic">Repasse <span class="text-orange-500">Gestor</span></h1>
            <p class="text-slate-400 text-[10px] font-semibold italic">Controle de Performance</p>
        </div>
        
        <div id="precisionDisplay" class="flex items-center gap-4 glass px-4 py-2 rounded-xl border-orange-500/20">
            <div>
                <span class="text-[8px] uppercase font-bold text-slate-400 block" id="precisionTitle">Mês Selecionado</span>
                <div id="precisionValue" class="text-sm font-black text-orange-500 leading-none">R$ 0,00</div>
            </div>
            <div class="flex flex-col items-center">
                <span class="text-[7px] font-bold text-slate-500 uppercase mb-1">C/ Pós</span>
                <label class="switch-pos"><input type="checkbox" id="checkExatoPos" checked><span class="slider"></span></label>
            </div>
        </div>

        <div class="flex gap-2 items-center">
            <div class="flex items-center glass px-3 py-1 rounded-lg gap-2 border-orange-500/10">
                <div class="flex flex-col">
                    <span class="text-[7px] font-bold text-orange-400 uppercase leading-none">Base</span>
                    <select id="compAnoBase" class="bg-transparent text-[10px] font-bold outline-none text-white cursor-pointer"></select>
                </div>
                <div class="h-4 w-[1px] bg-slate-700"></div>
                <div class="flex flex-col">
                    <span class="text-[7px] font-bold text-slate-400 uppercase leading-none">Ref</span>
                    <select id="compAnoRef" class="bg-transparent text-[10px] font-bold outline-none text-slate-300 cursor-pointer"></select>
                </div>
                <div id="yoyBadge" class="text-[10px] font-black px-2 py-0.5 rounded bg-slate-800">0%</div>
            </div>

            <select id="filterMes" class="bg-slate-800 border border-slate-700 rounded-lg px-2 py-1 text-[10px] font-bold text-white outline-none">
                <option value="todos">Todos os Meses</option>
                <option value="0">Jan</option><option value="1">Fev</option><option value="2">Mar</option>
                <option value="3">Abr</option><option value="4">Mai</option><option value="5">Jun</option>
                <option value="6">Jul</option><option value="7">Ago</option><option value="8">Set</option>
                <option value="9">Out</option><option value="10">Nov</option><option value="11">Dez</option>
            </select>
            <button id="btnOpenModal" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-1 px-4 rounded-lg shadow-xl text-[10px]">
                + LANÇAR
            </button>
        </div>
    </header>

    <div class="grid grid-cols-4 gap-3 mb-4">
        <div class="glass p-3 rounded-xl border-l-4 border-emerald-500">
            <span class="text-[8px] font-bold text-slate-400 uppercase block">Líquido Período</span>
            <div id="cardAnual" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
        <div class="glass p-3 rounded-xl border-l-4 border-orange-500">
            <span class="text-[8px] font-bold text-orange-400 uppercase block">Média Mensal</span>
            <div id="cardMediaLiq" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
        <div class="glass p-3 rounded-xl border-l-4 border-blue-500">
            <span class="text-[8px] font-bold text-blue-400 uppercase block">Média Sem Pós</span>
            <div id="cardMediaSemPos" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
        <div class="glass p-3 rounded-xl border-l-4 border-red-500">
            <span class="text-[8px] font-bold text-red-500 uppercase block">Total Glosas/Estornos</span>
            <div id="cardNeg" class="text-lg font-black text-white leading-tight">R$ 0,00</div>
        </div>
    </div>

    <div class="glass p-2 rounded-xl mb-4 flex gap-2 overflow-x-auto">
        <input type="checkbox" id="u1" value="Recife" class="unit-pill hidden" checked><label for="u1" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer whitespace-nowrap">RECIFE</label>
        <input type="checkbox" id="u2" value="Gravatá" class="unit-pill hidden" checked><label for="u2" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer whitespace-nowrap">GRAVATÁ</label>
        <input type="checkbox" id="u3" value="Bezerros" class="unit-pill hidden" checked><label for="u3" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer whitespace-nowrap">BEZERROS</label>
        <input type="checkbox" id="u4" value="Amaraji" class="unit-pill hidden" checked><label for="u4" class="px-3 py-1 rounded-md border border-slate-700 text-[9px] font-bold cursor-pointer whitespace-nowrap">AMARAJI</label>
    </div>

    <div class="grid grid-cols-2 gap-4 flex-grow overflow-hidden pb-2">
        <div class="glass p-4 rounded-[20px] h-full">
            <canvas id="mainChart"></canvas>
        </div>
        <div class="glass p-4 rounded-[20px] h-full">
            <canvas id="barChart"></canvas>
        </div>
    </div>

    <div id="dataModal" class="hidden fixed inset-0 z-50 bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-5xl rounded-[30px] border border-white/10 p-8 shadow-2xl overflow-y-auto max-h-[95vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold uppercase italic text-orange-500">Lançamento de Dados</h2>
                <div class="flex gap-4">
                    <button id="btnFetch" type="button" class="text-[10px] bg-blue-600 px-3 py-1 rounded-lg font-bold">CARREGAR</button>
                    <button id="btnCloseModal" class="text-4xl text-slate-500 hover:text-white">&times;</button>
                </div>
            </div>
            <form id="dataForm" class="space-y-6">
                <div class="grid grid-cols-3 gap-6 p-6 bg-slate-800/30 rounded-2xl">
                    <div><label class="block text-[10px] font-bold text-orange-500 uppercase mb-2">Unidade</label>
                        <select id="inUnidade" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-700 text-white"><option>Recife</option><option>Gravatá</option><option>Bezerros</option><option>Amaraji</option></select>
                    </div>
                    <div><label class="block text-[10px] font-bold text-orange-500 uppercase mb-2">Mês</label>
                        <select id="inMes" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-700 text-white"><option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Março</option><option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option><option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option><option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option></select>
                    </div>
                    <div><label class="block text-[10px] font-bold text-orange-500 uppercase mb-2">Ano</label>
                        <input type="number" id="inAno" value="2025" class="w-full bg-slate-800 p-3 rounded-xl border border-slate-700 text-white">
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Mensalidade (v1)</label><div class="money-field"><span>R$</span><input type="text" id="v1" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">PTC (v2)</label><div class="money-field"><span>R$</span><input type="text" id="v2" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Prouni (v3)</label><div class="money-field"><span>R$</span><input type="text" id="v3" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Negociações (v4)</label><div class="money-field"><span>R$</span><input type="text" id="v4" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-orange-400">Pós (v5)</label><div class="money-field"><span>R$</span><input type="text" id="v5" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Crédito (v6)</label><div class="money-field"><span>R$</span><input type="text" id="v6" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Cooperada (v7)</label><div class="money-field"><span>R$</span><input type="text" id="v7" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-slate-400">Nota Serv. (v8)</label><div class="money-field"><span>R$</span><input type="text" id="v8" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-blue-400">Dependências (v11)</label><div class="money-field"><span>R$</span><input type="text" id="v11" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-red-500">Débito (v9)</label><div class="money-field"><span>R$</span><input type="text" id="v9" class="money-input"></div></div>
                    <div class="space-y-1"><label class="text-[9px] uppercase font-bold text-red-500">Estornos (v10)</label><div class="money-field"><span>R$</span><input type="text" id="v10" class="money-input"></div></div>
                </div>
                <button type="submit" class="w-full bg-orange-600 py-4 rounded-xl font-black uppercase text-white hover:bg-orange-500">Salvar Dados</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBM35B6f1wetJCLtbVPo4wk0tQutE0vvug",
            authDomain: "repasse-unopar.firebaseapp.com",
            projectId: "repasse-unopar",
            databaseURL: "https://repasse-unopar-default-rtdb.firebaseio.com",
            storageBucket: "repasse-unopar.firebasestorage.app",
            appId: "1:71926249218:web:cebe16f726d6ddafbb341b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        Chart.register(ChartDataLabels);

        let dataCloud = [];
        const fmt = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
        const shortFmt = v => v >= 1000 ? (v / 1000).toFixed(1) + 'k' : v.toFixed(0);
        const parseV = v => parseFloat(v.toString().replace(/\./g, '').replace(',', '.')) || 0;
        const toBr = v => v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        document.querySelectorAll('.money-input').forEach(i => i.addEventListener('input', e => {
            let v = e.target.value.replace(/\D/g, "");
            v = (v / 100).toFixed(2).replace(".", ",");
            v = v.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            e.target.value = v;
        }));

        const commonOpt = {
            responsive: true, maintainAspectRatio: false,
            layout: { padding: { top: 30, bottom: 5, left: 5, right: 5 } },
            plugins: {
                legend: { display: false },
                datalabels: { color: '#94a3b8', font: { size: 9, weight: 'bold' }, anchor: 'end', align: 'top', formatter: v => v > 0 ? shortFmt(v) : '' }
            },
            scales: { 
                y: { display: true, grid: { color: 'rgba(255,255,255,0.03)' }, ticks: { display: false } }, 
                x: { ticks: { color: '#64748b', font: { size: 9 } }, grid: { display: false } } 
            }
        };

        const mainChart = new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: { 
                labels: ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'], 
                datasets: [
                    { label: 'Base', data: [], borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.05)', fill: true, tension: 0.4, pointRadius: 4 },
                    { label: 'Ref', data: [], borderColor: '#64748b', borderDash: [5, 5], fill: false, tension: 0.4, pointRadius: 0 }
                ] 
            },
            options: commonOpt
        });

        const barChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: { 
                labels: ['Mens.','PTC','Pro.','Negoc.','Pós','Outros','Glosas'], 
                datasets: [{ data: [], backgroundColor: ['#f97316','#3b82f6','#06b6d4','#f59e0b','#8b5cf6','#64748b','#ef4444'], borderRadius: 4 }] 
            },
            options: commonOpt
        });

        onValue(ref(db, 'lancamentos'), (snapshot) => {
            const data = snapshot.val();
            dataCloud = data ? Object.values(data) : [];
            
            const anosExistentes = [...new Set(dataCloud.map(d => d.a))].sort((a, b) => b - a);
            const baseSelect = document.getElementById('compAnoBase');
            const refSelect = document.getElementById('compAnoRef');
            
            const currentBase = baseSelect.value;
            const currentRef = refSelect.value;

            baseSelect.innerHTML = "";
            refSelect.innerHTML = "";

            if (anosExistentes.length === 0) {
                const anoAtual = new Date().getFullYear();
                baseSelect.innerHTML = `<option value="${anoAtual}">${anoAtual}</option>`;
                refSelect.innerHTML = `<option value="${anoAtual-1}">${anoAtual-1}</option>`;
            } else {
                anosExistentes.forEach(ano => {
                    baseSelect.innerHTML += `<option value="${ano}">${ano}</option>`;
                    refSelect.innerHTML += `<option value="${ano}">${ano}</option>`;
                });
            }

            baseSelect.value = currentBase || (anosExistentes.length > 0 ? anosExistentes[0] : new Date().getFullYear());
            refSelect.value = currentRef || (anosExistentes.length > 1 ? anosExistentes[1] : (anosExistentes[0] - 1 || new Date().getFullYear() - 1));

            updateDashboard();
        });

        function updateDashboard() {
            const selUnits = Array.from(document.querySelectorAll('.unit-pill:checked')).map(i => i.value);
            const baseSelect = document.getElementById('compAnoBase');
            const refSelect = document.getElementById('compAnoRef');
            if (!baseSelect.value || !refSelect.value) return;

            const anoBase = parseInt(baseSelect.value);
            const anoRef = parseInt(refSelect.value);
            const selMes = document.getElementById('filterMes').value;
            const comPosExato = document.getElementById('checkExatoPos').checked;

            let liqBase = Array(12).fill(0), liqRef = Array(12).fill(0), posBase = Array(12).fill(0);
            let cats = Array(7).fill(0);
            let totB = 0, glosasB = 0, countB = 0, totSemPosB = 0;
            let valComparativoRef = 0;

            dataCloud.forEach(d => {
                if (selUnits.includes(d.u)) {
                    const v5 = parseFloat(d.v.v5) || 0;
                    const ganhos = (d.v.v1 + d.v.v2 + d.v.v3 + d.v.v4 + v5 + d.v.v6 + d.v.v7 + d.v.v8);
                    const perdas = (d.v.v9 + d.v.v10);
                    const liq = ganhos - perdas;

                    if (d.a === anoBase) {
                        liqBase[d.m] += liq;
                        posBase[d.m] += v5;
                        totB += liq;
                        glosasB += (d.v.v9 + d.v.v10);
                        totSemPosB += (liq - v5);
                        countB++;

                        if (selMes === "todos" || parseInt(selMes) === d.m) {
                            cats[0] += d.v.v1; cats[1] += d.v.v2; cats[2] += d.v.v3;
                            cats[3] += d.v.v4; cats[4] += v5;
                            cats[5] += (d.v.v6 + d.v.v7 + d.v.v8 + (d.v.v11||0));
                            cats[6] += (d.v.v9 + d.v.v10);
                        }
                    }

                    if (d.a === anoRef) {
                        liqRef[d.m] += liq;
                        if (selMes === "todos" || parseInt(selMes) === d.m) {
                            valComparativoRef += liq;
                        }
                    }
                }
            });

            const yoyBadge = document.getElementById('yoyBadge');
            const valorAtual = selMes === "todos" ? totB : liqBase[parseInt(selMes)];

            if (valComparativoRef > 0) {
                const diff = ((valorAtual - valComparativoRef) / valComparativoRef) * 100;
                yoyBadge.innerText = (diff > 0 ? '+' : '') + diff.toFixed(1) + '%';
                yoyBadge.className = `text-[10px] font-black px-2 py-0.5 rounded ${diff >= 0 ? 'bg-emerald-500/20 text-emerald-500' : 'bg-red-500/20 text-red-500'}`;
            } else {
                yoyBadge.innerText = '0%';
                yoyBadge.className = 'text-[10px] font-black px-2 py-0.5 rounded bg-slate-800 text-slate-400';
            }

            document.getElementById('cardAnual').innerText = fmt.format(totB);
            document.getElementById('cardMediaLiq').innerText = fmt.format(totB / (countB || 1));
            document.getElementById('cardMediaSemPos').innerText = fmt.format(totSemPosB / (countB || 1));
            document.getElementById('cardNeg').innerText = fmt.format(glosasB);

            const idx = selMes === "todos" ? (new Date().getMonth()) : parseInt(selMes);
            const valFinal = comPosExato ? liqBase[idx] : (liqBase[idx] - posBase[idx]);
            document.getElementById('precisionValue').innerText = fmt.format(valFinal);
            
            mainChart.data.datasets[0].label = `Base ${anoBase}`;
            mainChart.data.datasets[1].label = `Ref ${anoRef}`;
            mainChart.data.datasets[0].data = liqBase;
            mainChart.data.datasets[1].data = liqRef;
            barChart.data.datasets[0].data = cats;
            mainChart.update(); 
            barChart.update();
        }

        document.getElementById('btnFetch').onclick = async () => {
            const u = document.getElementById('inUnidade').value, m = document.getElementById('inMes').value, a = document.getElementById('inAno').value;
            const snap = await get(ref(db, `lancamentos/${u}_${a}_${m}`));
            if (snap.exists()) {
                const d = snap.val().v;
                ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11'].forEach(id => {
                    document.getElementById(id).value = toBr(d[id] || 0);
                });
            } else { alert("Sem dados."); }
        };

        document.getElementById('dataForm').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('inUnidade').value, m = parseInt(document.getElementById('inMes').value), a = parseInt(document.getElementById('inAno').value);
            const rec = { u, m, a, v: {} };
            ['v1','v2','v3','v4','v5','v6','v7','v8','v9','v10','v11'].forEach(id => { rec.v[id] = parseV(document.getElementById(id).value); });
            await set(ref(db, `lancamentos/${u}_${a}_${m}`), rec);
            document.getElementById('dataModal').classList.add('hidden');
        };

        document.getElementById('btnOpenModal').onclick = () => document.getElementById('dataModal').classList.remove('hidden');
        document.getElementById('btnCloseModal').onclick = () => document.getElementById('dataModal').classList.add('hidden');
        document.getElementById('filterMes').onchange = updateDashboard;
        document.getElementById('compAnoBase').onchange = updateDashboard;
        document.getElementById('compAnoRef').onchange = updateDashboard;
        document.getElementById('checkExatoPos').onchange = updateDashboard;
        document.querySelectorAll('.unit-pill').forEach(cb => cb.onchange = updateDashboard);
    </script>
</body>
</html>
